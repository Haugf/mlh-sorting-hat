<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyMLH Hackathon Project</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="background-shapes" id="background-shapes"></div>
    <div class="container">
        <header>
            <h1>The Tech Sorting Hat</h1>
            <p>Discover Your True Hacker House</p>
        </header>

        <main id="app">
            <!-- Login State -->
            <div id="login-section">
                <p>Please log in to access your MLH profile.</p>
                <a href="/login" class="btn-login">Login with MyMLH</a>
            </div>

            <!-- Profile State -->
            <div id="profile-section" class="hidden">
                <h2>Welcome, <span id="user-name">Hacker</span>!</h2>

                <div class="profile-card">
                    <div class="profile-header">
                        <div class="avatar-placeholder" id="avatar"></div>
                        <div class="profile-info">
                            <h3 id="full-name"></h3>
                            <p id="email"></p>
                        </div>
                    </div>

                    <div class="profile-details">
                        <div class="detail-item">
                            <span class="label">School</span>
                            <span class="value" id="school">Loading...</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Major</span>
                            <span class="value" id="major">Loading...</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Level of Study</span>
                            <span class="value" id="level">Loading...</span>
                        </div>
                    </div>
                </div>

                <div id="sorting-hat-section" style="margin-top: 30px; text-align: center;">
                    <button id="sort-btn" class="btn-primary">ðŸŽ© Let the Tech Sorting Hat Decide My Fate ðŸŽ©</button>

                    <div id="sorting-result" class="hidden card-flip-container">
                        <div class="house-card">
                            <img id="mascot-image" src="" alt="Mascot" class="mascot-img">
                            <h2 id="house-name"></h2>
                            <p id="house-desc" style="font-style: italic;"></p>
                            <hr>
                            <div class="magic-item">
                                <strong>Wand:</strong> <span id="wand-type"></span>
                            </div>
                            <div class="magic-item">
                                <strong>Patronus:</strong> <span id="patronus-type"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="raw-data-section"
                    style="margin-top: 40px; text-align: left; border-top: 1px solid #eee; padding-top: 20px;">
                    <h4 style="color: #999; cursor: pointer;"
                        onclick="document.getElementById('raw-json').classList.toggle('hidden')">Show/Hide Raw API
                        Response</h4>
                    <pre id="raw-json" class="hidden"
                        style="background: #f4f4f4; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 11px; color: #555;"></pre>
                </div>

                <button id="logout-btn" class="btn-secondary">Logout</button>
            </div>
        </main>
    </div>

    <script src="sortingHat.js"></script>
    <script>
        // Global error handler
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            alert('Error: ' + msg + '\nLine: ' + lineNo);
            return false;
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const loginSection = document.getElementById('login-section');
            const profileSection = document.getElementById('profile-section');
            let currentUser = null;

            // Check for token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (token) {
                localStorage.setItem('mlh_access_token', token);
                window.history.replaceState({}, document.title, "/");
                showProfile(token);
            } else {
                const storedToken = localStorage.getItem('mlh_access_token');
                if (storedToken) {
                    showProfile(storedToken);
                } else {
                    showLogin();
                }
            }

            document.getElementById('logout-btn').addEventListener('click', () => {
                localStorage.removeItem('mlh_access_token');
                showLogin();
            });

            document.getElementById('sort-btn').addEventListener('click', () => {
                try {
                    if (!currentUser) {
                        alert("No user data found!");
                        return;
                    }

                    // Verify sortingHat.js loaded
                    if (typeof sortHacker !== 'function') {
                        throw new Error("sortingHat.js failed to load or sortHacker is not defined");
                    }

                    const result = sortHacker(currentUser);
                    displaySortingResult(result);
                } catch (e) {
                    console.error(e);
                    alert("Sorting Error: " + e.message);
                }
            });

            function showLogin() {
                loginSection.classList.remove('hidden');
                profileSection.classList.add('hidden');
            }

            async function showProfile(token) {
                loginSection.classList.add('hidden');
                profileSection.classList.remove('hidden');

                try {
                    const response = await fetch('/api/me', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch user data');
                    }

                    const userData = await response.json();
                    currentUser = userData;
                    renderUserData(userData);
                } catch (error) {
                    console.error(error);
                    alert('Session expired or invalid. Please login again.');
                    localStorage.removeItem('mlh_access_token');
                    showLogin();
                }
            }

            function renderUserData(user) {
                if (!user) return;

                const firstName = user.first_name || 'Hacker';
                const lastName = user.last_name || '';
                const email = user.email || 'No email provided';

                document.getElementById('user-name').textContent = firstName;
                document.getElementById('full-name').textContent = `${firstName} ${lastName}`.trim();
                document.getElementById('email').textContent = email;

                // Avatar (Initials) - Safe check
                let initials = 'H';
                if (firstName && firstName.length > 0) {
                    initials = firstName[0];
                    if (lastName && lastName.length > 0) {
                        initials += lastName[0];
                    }
                }
                document.getElementById('avatar').textContent = initials.toUpperCase();

                if (user.education && user.education.length > 0) {
                    const edu = user.education[0];
                    document.getElementById('school').textContent = edu.school_name || 'N/A';
                    document.getElementById('major').textContent = edu.major || 'N/A';
                    document.getElementById('level').textContent = edu.level_of_study || 'N/A';
                } else {
                    document.getElementById('school').textContent = 'No education info';
                    document.getElementById('major').textContent = '-';
                    document.getElementById('level').textContent = '-';
                }

                // Show raw JSON (hidden by default now)
                document.getElementById('raw-json').textContent = JSON.stringify(user, null, 2);
            }

            function displaySortingResult(result) {
                const resultDiv = document.getElementById('sorting-result');
                const btn = document.getElementById('sort-btn');

                // Hide button, show result
                btn.classList.add('hidden');
                resultDiv.classList.remove('hidden');

                // Populate content
                const houseCard = resultDiv.querySelector('.house-card');
                document.getElementById('house-name').textContent = `House ${result.house.name}`;
                document.getElementById('house-name').style.color = result.house.color;
                document.getElementById('house-desc').textContent = result.house.description;
                document.getElementById('wand-type').textContent = result.wand;
                document.getElementById('patronus-type').textContent = result.patronus;

                // Set Image
                const img = document.getElementById('mascot-image');
                img.src = result.house.image;
                img.style.borderColor = result.house.color;

                // Apply House Color Border
                houseCard.style.borderTop = `5px solid ${result.house.color}`;
            }

            // Generate Floating Code
            function createFloatingCode() {
                const symbols = ['{ }', '</>', 'function()', 'if', 'else', 'return', '0', '1', 'var', 'const', '=>', ';'];
                const container = document.getElementById('background-shapes');
                const count = 20;

                for (let i = 0; i < count; i++) {
                    const span = document.createElement('span');
                    span.classList.add('shape');
                    span.textContent = symbols[Math.floor(Math.random() * symbols.length)];

                    // Random positioning
                    span.style.left = Math.random() * 100 + 'vw';
                    span.style.top = Math.random() * 100 + 'vh';
                    span.style.fontSize = (Math.random() * 20 + 10) + 'px';

                    // Random animation
                    const duration = Math.random() * 10 + 10;
                    const delay = Math.random() * 5;
                    span.style.animation = `float ${duration}s linear ${delay}s infinite`;

                    container.appendChild(span);
                }
            }
            createFloatingCode();
        });
    </script>
</body>

</html>